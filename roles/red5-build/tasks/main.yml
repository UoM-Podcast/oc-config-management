---

- name: Install Java
  apt: pkg=openjdk-7-jdk update_cache=yes state=present
  sudo: yes

- name: Install Ant
  apt: pkg=ant state=present
  sudo: yes

- name: Install NFS Client
  apt: pkg=nfs-common state=present
  sudo: yes

- name: Install unzip
  apt: pkg=unzip state=present
  sudo: yes

- name: Create MH parent dir
  shell: mkdir -p {{ mh_parent_dir }}
  sudo: yes

- name: Fix MH parent dir permissions
  file: path={{mh_parent_dir}}/ owner=matterhorn group=matterhorn state=directory recurse=true
  sudo: true

- name: Create streaming parent dir
  shell: mkdir -p {{streaming_home}}

- name: Create MH shared dir
  shell: mkdir -p {{mh_work_dir}}

  #Mount NFS
- include: ../../common/tasks/nfs_mount.yml

- name: Create MH streams dir
  shell: mkdir -p {{mh_streaming_dir}}

- name: Downloading Red5
  get_url: url=http://red5.org/downloads/red5/1_0/red5-1.0.0.tar.gz
           dest={{streaming_home}}/red5-1.0.0.tar.gz
           force=no
           mode=0644

- name: Unzipping Red5
  shell: tar xzf red5-1.0.0.tar.gz
         chdir={{streaming_home}}
         creates=red5-1.0.0-build-jenkins-red5-226

- name: Symlinking Red5
  shell: ln -s red5-1.0.0-build-jenkins-red5-226 red5
         chdir={{streaming_home}}
         creates=red5

- name: Downloading Matterhorn streaming components
  get_url: url=https://bitbucket.org/opencast-community/matterhorn-engage-streaming/get/master.tar.gz
           dest={{streaming_home}}/matterhorn-streaming-master.tar.gz
           force=no
           mode=0644

- name: Unzipping Matterhorn streaming components5
  shell: tar xzf matterhorn-streaming-master.tar.gz
         chdir={{streaming_home}}
         creates=opencast-community-matterhorn-engage-streaming-*

- name: Symlinking Matterhorn streaming components
  shell: ln -s opencast-community-matterhorn-engage-streaming-* matterhorn-engage-streaming
         chdir={{streaming_home}}
         creates=matterhorn-engage-streaming

- name: Building Matterhorn streaming application
  shell: ant
         chdir={{streaming_home}}/matterhorn-engage-streaming/for-1.0-and-newer-red5

- name: Applying Matterhorn streaming application to Red5
  shell: unzip matterhorn-engage-streaming/for-1.0-and-newer-red5/dist/*.war -d red5/webapps/matterhorn
         chdir={{streaming_home}}
         creates=red5/webapps/matterhorn

- name: Setup Red5 Mounts
  mount: name={{mh_streaming_dir}} src={{streaming_home}}/red5/webapps/matterhorn/streams fstype=none state=mounted opts=bind
  sudo: yes

- name: Configure red5 init script
  template: src=red5 dest=/etc/init.d/red5
  sudo: yes

- name: Fixing init script permissions
  shell: chmod a+x /etc/init.d/red5
  sudo: yes

- name: Setting Red5 to start on boot
  service: name=red5 enabled=yes
  sudo: yes
